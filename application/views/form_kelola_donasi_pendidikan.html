<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta content="width=device-width, initial-scale=1, maximum-scale=1, shrink-to-fit=no" name="viewport">
  <title>Form Data Donasi | Cheetah</title>

  <!-- General CSS Files -->
  <link rel="stylesheet" href="assets/modules/bootstrap/css/bootstrap.min.css">
  <link rel="stylesheet" href="assets/modules/fontawesome/css/all.min.css">

  <!-- CSS Libraries -->
  <link rel="stylesheet" href="assets/modules/datatables/datatables.min.css">
  <link rel="stylesheet" href="assets/modules/datatables/DataTables-1.10.16/css/dataTables.bootstrap4.min.css">
  <link rel="stylesheet" href="assets/modules/datatables/Select-1.2.4/css/select.bootstrap4.min.css">
  <link rel="stylesheet" href="assets/modules/summernote/summernote-bs4.css">

  <style type="text/css">
  	.type-progress-container {
	  position: relative;
	  height: 3px;
	  opacity: 0;
	  background: #f5f5f5;
	}

	.type-progress-container.focus { opacity: 1; }

	.type-progress-container .type-progress {
	  position: absolute;
	  left: 0;
	  top: 0;
	  bottom: 0;
	  width: 0%;
	  background: #337ab7;
	}
  </style>

  <!-- Template CSS -->
  <link rel="stylesheet" href="assets/css/style.css">
  <link rel="stylesheet" href="assets/css/components.css">
<!-- Start GA -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-94034622-3"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-94034622-3');
</script>
<!-- /END GA --></head>

<body>
  <div id="app">
    <div class="main-wrapper main-wrapper-1">
      <div class="navbar-bg"></div>
      <nav class="navbar navbar-expand-lg main-navbar">
        <form class="form-inline mr-auto">
			<ul class="navbar-nav mr-3">
			  <li><a href="#" data-toggle="sidebar" class="nav-link nav-link-lg"><i class="fas fa-bars"></i></a></li>
			</ul>
		  </form>
		  <ul class="navbar-nav mr-3">
			<li><a href="#" data-toggle="search" class="nav-link nav-link-lg d-sm"><i class="fa fa-sign-out-alt" style='font-size:23px'></i></a></li>
		  </ul>
		  <ul class="navbar-nav navbar-right">
          
        </ul>
      </nav>
      <div class="main-sidebar sidebar-style-2">
        <aside id="sidebar-wrapper">
          <div class="sidebar-brand">
            <a href="index.html">Danawira</a>
          </div>
          <div class="sidebar-brand sidebar-brand-sm">
            <a href="index.html">DNW</a>
          </div>
          <ul class="sidebar-menu">
            <li class="menu-header">Menu</li>
            <li class="active"><a class="nav-link" href="kelola_donasi_pendidikan.html"><i class="fas fa-school"></i> <span>Pendidikan</span></a></li>
            <li><a class="nav-link" href="kelola_donasi_bencanaAlam.html"><i class="fas fa-house-damage"></i> <span>Bencana Alam</span></a></li>
            <li><a class="nav-link" href="kelola_donasi_sosial.html"><i class="fas fa-users"></i> <span>Sosial</span></a></li>
            <li><a class="nav-link" href="kelola_donasi_kemalangan.html"><i class="fas fa-dizzy"></i> <span>Kemalangan</span></a></li>
            <li><a class="nav-link" href="kelola_donasi_event.html"><i class="fas fa-microphone"></i> <span>Event</span></a></li>
            <li><a class="nav-link" href="kelola_donasi_lainnya.html"><i class="fas fa-ellipsis-h"></i> <span>Lainnya</span></a></li>
            
            <li class="menu-header">Data Master</li>
            <li><a class="nav-link" href="kelola_pengumuman.html"><i class="fas fa-bullhorn"></i> <span>Pengumuman</span></a></li>
          </ul>
        </aside>
      </div>

      <!-- Main Content -->
      <div class="main-content">
        <section class="section">
          <div class="section-header">
            <h1>Form Data Donasi Pendidikan </h1>
            <div class="section-header-breadcrumb">
              <div class="breadcrumb-item active"><a href="#">Beranda</a></div>
              <div class="breadcrumb-item"><a href="#">Kelola Donasi Pendidikan</a></div>
              <div class="breadcrumb-item">Form</div>
            </div>
          </div>

          <div class="section-body">
            
            <div class="row">
              <div class="col-12">
                <div class="card">
                  <div class="card-body">

                  	<form id="form_donasi">
	                    <div class="form-group row mb-4">
	                      <label class="col-form-label text-md-right col-12 col-md-3 col-lg-3">Judul Donasi</label>
	                      <div class="col-sm-12 col-md-7">
	                        <input type="text" class="form-control progres" id="judul" maxlength="150" placeholder="Tulis judul (hanya 150 character)" required="">
	                      </div>
	                    </div>
	                    <!-- <div class="form-group row mb-4">
	                      <label class="col-form-label text-md-right col-12 col-md-3 col-lg-3">Kategori Donasi</label>
	                      <div class="col-sm-12 col-md-7">
	                        <select class="form-control selectric" id="kategori">
	                          <option>Dakwah</option>
	                          <option>Pengembangan Dakwah</option>
	                          <option>Pendidikan dan Pelatihan (Diklat)</option>
	                          <option>Pustaka dan Media</option>
	                          <option>Pengelolaan Gedung</option>
	                          <option>Sosial dan Kerjasama Kelembagaan</option>
	                          <option>Ummahat</option>
	                        </select>
	                      </div>
	                    </div> -->
	                    <div class="form-group row mb-4">
	                      <label class="col-form-label text-md-right col-12 col-md-3 col-lg-3">Informasi Bank</label>
	                      <div class="col-sm-12 col-md-3">
	                        <input type="text" class="form-control" required="" id="nama_bank" placeholder="Nama Bank">
	                      </div>
	                      <div class="col-sm-12 col-md-2">
	                        <input type="text" class="form-control" required="" id="nomor_rek" placeholder="Nomor Rekening">
	                      </div>
	                      <div class="col-sm-12 col-md-2">
	                        <input type="text" class="form-control" required="" id="atas_nama" placeholder="Atas Nama">
	                      </div>
	                    </div>
	                    <div class="form-group row mb-4">
	                      <label class="col-form-label text-md-right col-12 col-md-3 col-lg-3">Target Terkumpul</label>
	                      <div class="col-sm-12 col-md-7">
	                        <input type="text" class="form-control uang" required="" id="target">
	                      </div>
	                    </div>
	                    <div class="form-group row mb-4">
	                      <label class="col-form-label text-md-right col-12 col-md-3 col-lg-3">Batas Waktu Donasi</label>
	                      <div class="col-sm-12 col-md-7">
	                         <input type="datetime-local" class="form-control" id="tanggal_selesai" required="">
	                      </div>
	                    </div>
	                    <div class="form-group row mb-4">
	                      <label class="col-form-label text-md-right col-12 col-md-3 col-lg-3">Deskripsi</label>
	                      <div class="col-sm-12 col-md-7">
	                        <textarea class="summernote-simple" required="" id="deskripsi"></textarea>
	                      </div>
	                    </div>
	                    <div class="form-group row mb-4">
	                      <label class="col-form-label text-md-right col-12 col-md-3 col-lg-3">Gambar Banner</label>
	                      <div class="col-sm-12 col-md-7">
	                        <input type="file" name="img[]" id="fileBanner" class="form-control" accept="image/*"><br>
	                        <img src="https://placehold.it/400x200" width="400" ="" id="preview" class="img-thumbnail">
	                      </div>
	                    </div>
                    
	                    <div class="form-group row mb-4">
	                      <label class="col-form-label text-md-right col-12 col-md-3 col-lg-3"></label>
	                      <div class="col-sm-12 col-md-7">
	                        <button type="submit" class="btn btn-primary">Publish</button>
	                      </div>
	                    </div>

                    </form>

                  </div>
                </div>
              </div>
            </div>

          </div>
        </section>
      </div>
      <footer class="main-footer">
        <?php $tahun = ('Y'); ?>
        <div class="footer-left">
          Copyright &copy; <?php $tahun ?> <div class="bullet"></div> <a href="#">IKA PCR</a>
        </div>
        <div class="footer-right">
          
        </div>
      </footer>
    </div>
  </div>

  <!-- General JS Scripts -->
  <script src="assets/modules/jquery.min.js"></script>
  <script src="assets/modules/popper.js"></script>
  <script src="assets/modules/tooltip.js"></script>
  <script src="assets/modules/bootstrap/js/bootstrap.min.js"></script>
  <script src="assets/modules/nicescroll/jquery.nicescroll.min.js"></script>
  <script src="assets/modules/moment.min.js"></script>
  <script src="assets/js/stisla.js"></script>
  
  <!-- JS Libraies -->
  <script src="assets/modules/datatables/datatables.min.js"></script>
  <script src="assets/modules/datatables/DataTables-1.10.16/js/dataTables.bootstrap4.min.js"></script>
  <script src="assets/modules/datatables/Select-1.2.4/js/dataTables.select.min.js"></script>
  <script src="assets/modules/jquery-ui/jquery-ui.min.js"></script>
  <script src="assets/modules/sweetalert/sweetalert.min.js"></script>
  <script src="assets/modules/summernote/summernote-bs4.js"></script>

  <!-- Page Specific JS File -->
  <script src="assets/js/page/modules-datatables.js"></script>
  <script src="assets/js/page/modules-sweetalert.js"></script>
  
  <!-- Template JS File -->
  <script src="assets/js/scripts.js"></script>
  <script src="assets/js/custom.js"></script>

  <!-- new js -->
  <script src="js/jquery.typeProgress.js"></script>
  <script src="js/jquery.mask.js"></script>

  <!-- <script src="https://www.gstatic.com/firebasejs/4.8.1/firebase.js"></script> -->
  <script src="https://www.gstatic.com/firebasejs/8.2.9/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.2.9/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.2.9/firebase-storage.js"></script>

  <script type="text/javascript" src="js/app.js"></script>


  <script type="text/javascript">
  	const queryString = window.location.search;
  	const urlParams = new URLSearchParams(queryString);
  	const key = urlParams.get('param');
  	var action = "";
 
    if(key){
  		var database = firebase.database();
		// This is reference to tha database, to fetch data from database use below code:
		var starCountRef = firebase.database().ref('Donasi/'+key);
		// Add ref of child if any
		starCountRef.on('value', function(snapshot) {
		  if (snapshot.exists()) {
		  	action = "edit";
		  	$("#judul").val(snapshot.val().judul);
		  	$("#target").val(snapshot.val().target);
		  	$("#kategori").val(snapshot.val().kategori);

		  	
		  	$("#nama_bank").val(snapshot.val().nama_bank);
		  	$("#nomor_rek").val(snapshot.val().nomor_rek);
		  	$("#atas_nama").val(snapshot.val().atas_nama);

		  	$("#tanggal_selesai").val(snapshot.val().tanggal_selesai);
		  	document.getElementById("preview").src = snapshot.val().foto;
		  	$('#deskripsi').summernote("code","");
		  	$('#deskripsi').summernote('code', snapshot.val().deskripsi);
		  	console.log(action);
		  }
		  else {
		  	action = "tambah";
		  	$("#judul").val("");
		  	$("#target").val("");
		  	// $("#kategori").val("");
		  	$('#deskripsi').summernote("code","");
		  	console.log(action);
		  }
		});
  	}else{
  		action = "tambah";
  		console.log(action);
  	}

  	document.getElementById("tanggal_selesai").min = new Date().toJSON().slice(0,10)+"T00:00";
  	$(document).ready(function(){
  	  // Format mata uang.
      $( '.uang' ).mask('000.000.000.000.000', {reverse: true});
    })
  	$('.progres').each(function() {
	  $(this).typeProgress();
	});
  	$('.summernote-simple').summernote({
    	height: '200px',
    	toolbar: [
    		['misc', ['undo','redo']],
	        ['style', ['bold', 'italic', 'underline']],
	        ['color', ['color']],
	        ['para', ['ul', 'ol', 'paragraph']]
    	]
	});
  	$('input[type="file"]').change(function(e) {
	  var fileName = e.target.files[0].name;
	  // $("#file").val(fileName);

	  var reader = new FileReader();
	  reader.onload = function(e) {
	    // get loaded data and render thumbnail.
	    document.getElementById("preview").src = e.target.result;
	  };
	  // read the image file as a data URL.
	  reader.readAsDataURL(this.files[0]);
	});
  </script>
  <script type="text/javascript">
  	
	$('#form_donasi').off('submit').on('submit', function(event){
		event.preventDefault();
		if(action=="tambah"){
			console.log("tombol di tekan");
			var databaseRef = firebase.database().ref("Donasi/");
	        var pushData = databaseRef.push({
	            judul: $("#judul").val(),
	            deskripsi: $('#deskripsi').summernote('code'),
	            target: $("#target").val(),
	            terkumpul: 0,
	            organisasi: "Cheetah Erje",

	            nama_bank: $("#nama_bank").val(),
	            nomor_rek: $("#nomor_rek").val(),
	            atas_nama: $("#atas_nama").val(),

	            tanggal_mulai: new Date().toJSON().slice(0,16),
	            tanggal_selesai: $("#tanggal_selesai").val(),
	           	kategori : $("#kategori").val(),
	            foto:"",
	            id:""
	        }, function(error){
	            if (error) {
	             console.error(error)
	             	swal({
	                  title: "Ups.. terjadi masalah",
	                  icon: "error"
	                });
	             return
	            }
	            console.log('Push successful');
	            //add upload function here
	            console.log("keynya : "+pushData.key);
	            databaseRef.child('/'+pushData.key).update({id:pushData.key});

	            var file = document.getElementById("fileBanner").files[0];
	            var storageRef = firebase.storage().ref('donasi/'+pushData.key);
	    		var uploadTask = storageRef.put(file);

	    		uploadTask.then(function(snapshot) {
				  snapshot.ref.getDownloadURL().then( 
		              function(downloadURL) { 
		              // print the image url  
		              console.log(downloadURL);
		              databaseRef.child('/'+pushData.key).update({foto:downloadURL});
		              swal({
		                 title: "Berhasil Publish Data",
		                 icon: "success"
		              }).then(function() {
		                 window.location = "kelola_donasi_pendidikan.html";
		              });
		          }); 
				});
	        });
	    }

	    if(action=="edit"){
	    	var file = document.getElementById("fileBanner").files[0];
	    	var databaseRef = firebase.database().ref("Donasi/");
	    	if(file){
	    		//jika ganti banner atau foto
	    		var storageRef = firebase.storage().ref('donasi/'+key);
	    		// Delete the file
				storageRef.delete().then(function() {
				  	// File deleted successfully
				  	var uploadTask = storageRef.put(file);

		    		uploadTask.then(function(snapshot) {
					  snapshot.ref.getDownloadURL().then( 
			              function(downloadURL) { 
			              // print the image url  
			              console.log(downloadURL);
			              databaseRef.child('/'+key).update({
			              	judul: $("#judul").val(),

			              	nama_bank: $("#nama_bank").val(),
				            nomor_rek: $("#nomor_rek").val(),
				            atas_nama: $("#atas_nama").val(),

				            deskripsi: $('#deskripsi').summernote('code'),
				            target: $("#target").val(),
				            tanggal_selesai: $("#tanggal_selesai").val(),
				           	kategori : $("#kategori").val(),
			              	foto:downloadURL
			              });
			          }); 
					});
					swal({
	                  title: "Berhasil Edit",
	                  icon: "success"
	                }).then(function() {
	                    window.location = "kelola_donasi_pendidikan.html";
	                });
				}).catch(function(error) {
				  	// Uh-oh, an error occurred!
				  	console.log(error)
				});
	    	}else{
	    		//jika tidak ganti banner atau foto
	    		databaseRef.child('/'+key).update({
	              	judul: $("#judul").val(),

	              	nama_bank: $("#nama_bank").val(),
		            nomor_rek: $("#nomor_rek").val(),
		            atas_nama: $("#atas_nama").val(),
		            
		            deskripsi: $('#deskripsi').summernote('code'),
		            target: $("#target").val(),
		            tanggal_selesai: $("#tanggal_selesai").val(),
		           	kategori : $("#kategori").val()
	            });
	            swal({
                  title: "Berhasil Edit",
                  icon: "success"
                }).then(function() {
                   window.location = "kelola_donasi_pendidikan.html";
                });
	    	}
	    }
	});
  </script>
</body>
</html>